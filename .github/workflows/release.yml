# =============================================================================
# GitHub Actions Workflow - Release avec Docker
# =============================================================================
# D√©clench√© sur:
#   - Push d'un tag (v*)
#   - Manuellement via workflow_dispatch
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================================================
  # Job 1: Tests et validation
  # ===========================================================================
  test:
    name: Tests & Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Install Bloomberg API
        run: |
          pip install --index-url=https://blpapi.bloomberg.com/repository/releases/python/simple/ blpapi || \
          echo "::warning::blpapi installation failed - Bloomberg features will be disabled in tests"

      - name: Install C++ build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++
          pip install pybind11

      - name: Build C++ module
        run: |
          cd src/myproject/strategy/cpp
          pip install . || echo "::warning::C++ module build failed"
          cd ../../../..

      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: Test imports
        run: |
          python -c "import streamlit; print('‚úì streamlit')"
          python -c "import plotly; print('‚úì plotly')"
          python -c "import pandas; print('‚úì pandas')"

  # ===========================================================================
  # Job 2: Build Docker Image
  # ===========================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # ===========================================================================
  # Job 3: Build Windows Executable
  # ===========================================================================
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install Bloomberg API
        run: |
          pip install --index-url=https://blpapi.bloomberg.com/repository/releases/python/simple/ blpapi
        continue-on-error: true

      - name: Install C++ build tools
        run: |
          pip install pybind11

      - name: Build C++ module
        run: |
          cd src/myproject/strategy/cpp
          pip install .
          cd ../../../..
        continue-on-error: true

      - name: Create launcher script
        run: |
          @"
          import subprocess
          import sys
          import os
          
          # Set the working directory
          os.chdir(os.path.dirname(os.path.abspath(__file__)))
          
          # Run streamlit
          subprocess.run([
              sys.executable, '-m', 'streamlit', 'run',
              'src/myproject/app.py',
              '--server.port=8501',
              '--server.headless=true'
          ])
          "@ | Out-File -FilePath launcher.py -Encoding utf8

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --name "Option Strategy" `
            --add-data "src;src" `
            --add-data "assets;assets" `
            --add-data ".streamlit;.streamlit" `
            --hidden-import streamlit `
            --hidden-import streamlit.runtime.scriptrunner `
            --hidden-import plotly `
            --hidden-import pandas `
            --hidden-import numpy `
            --collect-all streamlit `
            --collect-all plotly `
            --icon "assets/icon.ico" `
            --noconfirm `
            launcher.py
        continue-on-error: true

      - name: Check build output
        run: |
          if (Test-Path "dist/Option Strategy") {
            Write-Host "Build successful!"
            Get-ChildItem "dist/Option Strategy" -Recurse | Measure-Object | Select-Object -ExpandProperty Count
          } else {
            Write-Host "Build failed - dist folder not found"
            Get-ChildItem dist -ErrorAction SilentlyContinue
          }

      - name: Create ZIP archive
        run: |
          if (Test-Path "dist/Option Strategy") {
            Compress-Archive -Path "dist/Option Strategy/*" -DestinationPath "Option-Strategy-Windows-x64.zip" -Force
            Write-Host "ZIP created successfully"
          } else {
            Write-Host "Cannot create ZIP - build folder missing"
            exit 1
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable
          path: Option-Strategy-Windows-x64.zip
          if-no-files-found: warn

  # ===========================================================================
  # Job 4: Create GitHub Release
  # ===========================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-docker, build-windows]
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-executable
          path: ./artifacts
        continue-on-error: true

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate Release Notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## üöÄ Option Strategy Analyzer ${{ steps.get_version.outputs.VERSION }}
          
          ### üì¶ Installation
          
          #### Option 1: Docker (Recommand√©)
          ```bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_version.outputs.VERSION }}
          docker run -p 8501:8501 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_version.outputs.VERSION }}
          ```
          
          #### Option 2: Windows Executable
          T√©l√©chargez `Option-Strategy-Windows-x64.zip` et ex√©cutez l'application.
          
          #### Option 3: Installation manuelle
          ```bash
          git clone https://github.com/${{ github.repository }}.git
          cd option-strategy
          pip install -r requirements.txt
          pip install --index-url=https://blpapi.bloomberg.com/repository/releases/python/simple/ blpapi
          streamlit run src/myproject/app.py
          ```
          
          ### üîß D√©pendances incluses
          - ‚úÖ Python 3.11
          - ‚úÖ Bloomberg API (blpapi)
          - ‚úÖ Module C++ optimis√© (strategy_metrics_cpp)
          - ‚úÖ Streamlit, Plotly, Pandas
          
          ### üìù Notes
          - L'API Bloomberg n√©cessite un terminal Bloomberg actif
          - Le module C++ acc√©l√®re les calculs de m√©triques
          
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Option Strategy Analyzer ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ./artifacts/Option-Strategy-Windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
